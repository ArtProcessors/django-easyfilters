language: python

python:
  - "2.7"
  - "2.6"
  - "3.2"
  - "3.3"
  - "pypy"

env:
  global:
    PYTHONPATH=src:tests
    PYTHONUNBUFFERED=yes
    DJANGO_SETTINGS_MODULE=test_project.settings
  matrix:
    - WITH_COVERAGE=yes DEPS="python-dateutil six django>=1.3,<1.4"
    - WITH_COVERAGE=yes DEPS="python-dateutil six django>=1.4,<1.5"
    - WITH_COVERAGE=yes DEPS="python-dateutil six django>=1.5,<1.6"
    - WITH_COVERAGE=yes DEPS="python-dateutil six https://www.djangoproject.com/download/1.6b4/tarball/"
    - WITH_COVERAGE=no DEPS="python-dateutil six django>=1.3,<1.4"
    - WITH_COVERAGE=no DEPS="python-dateutil six django>=1.4,<1.5"
    - WITH_COVERAGE=no DEPS="python-dateutil six django>=1.5,<1.6"
    - WITH_COVERAGE=no DEPS="python-dateutil six https://www.djangoproject.com/download/1.6b4/tarball/"

matrix:
  exclude:
    - python: "3.3"
      env: WITH_COVERAGE=yes DEPS="python-dateutil six django>=1.3,<1.4" 
    - python: "3.3"
      env: WITH_COVERAGE=no DEPS="python-dateutil six django>=1.3,<1.4"
    - python: "3.3"
      env: WITH_COVERAGE=yes DEPS="python-dateutil six django>=1.4,<1.5"
    - python: "3.3"
      env: WITH_COVERAGE=no DEPS="python-dateutil six django>=1.4,<1.5"
    
    - python: "3.2"
      env: WITH_COVERAGE=yes DEPS="python-dateutil six django>=1.3,<1.4" 
    - python: "3.2"
      env: WITH_COVERAGE=no DEPS="python-dateutil six django>=1.3,<1.4"
    - python: "3.2"
      env: WITH_COVERAGE=yes DEPS="python-dateutil six django>=1.4,<1.5"
    - python: "3.2"
      env: WITH_COVERAGE=no DEPS="python-dateutil six django>=1.4,<1.5"
      
    
before_install:
  - |
    if python --version |& grep PyPy; then
      deactivate
      (
        cd ~
        wget "https://bitbucket.org/pypy/pypy/downloads/pypy-2.1-linux64.tar.bz2"
        tar -xf pypy-2.1-linux64.tar.bz2
        sudo rm -rf ~/virtualenv/pypy
        virtualenv --python=pypy-2.1/bin/pypy ~/virtualenv/pypy
      )
      source ~/virtualenv/pypy/bin/activate
    fi
    python --version
    uname -a
    lsb_release -a
 
install: 
  - pip install $DEPS
  - if [[ $WITH_COVERAGE == yes ]]; then pip install coverage coveralls; fi

script: 
  - python --version
  - rm .coverage* || true
  - |
    if [[ $WITH_COVERAGE == yes ]]; then
      coverage run --source=src --parallel-mode `which django-admin.py` test test_app;
    else
      django-admin.py test test_app;
    fi

after_success:
  - coverage combine || true
  - coverage report --show-missing --include='src/*' || true
  - coveralls || true
